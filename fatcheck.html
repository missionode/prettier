<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <link rel="manifest" href="manifest.json" />
  <title>Nuyou Your Lifestyle buddy | Fat Estimator</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <div class="container" style="flex: 1; justify-content: flex-start; padding-top: 20px;">
    <h1>Fat Estimator</h1>

    <div class="glass-panel" style="width: 100%; max-width: 500px;">
      <label style="color: white; display: block; margin-bottom: 10px;">Enter your height:</label>
      <div style="display: flex; justify-content: center; align-items: center; flex-wrap: wrap;">
        <input type="number" id="heightInput" placeholder="e.g. 170 or 5.7" step="any"
          style="flex: 1; min-width: 150px;">
        <select id="unitSelect" style="width: 100px;">
          <option value="cm">cm</option>
          <option value="feet">feet</option>
        </select>
      </div>
      <button onclick="startCamera()" class="btn-glass" style="width: 100%; margin-top: 15px;">Start Scan</button>
    </div>

    <div class="media-container" style="display: none;" id="videoContainer">
      <video id="video" autoplay muted playsinline></video>
      <canvas id="canvas" hidden></canvas>
    </div>

    <div id="result" class="glass-panel"
      style="display: none; margin-top: 20px; width: 100%; max-width: 500px; text-align: left;"></div>
  </div>

  <div class="bottom-nav">
    <a href="makeup.html" class="nav-item">
      <i class="fa-solid fa-wand-magic-sparkles"></i>
      Make up
    </a>
    <a href="fatcheck.html" class="nav-item active">
      <i class="fa-solid fa-person"></i>
      Fat Check
    </a>
    <a href="skintonecheck.html" class="nav-item">
      <i class="fas fa-palette"></i>
      Skin Tone
    </a>
  </div>

  <!-- FaceMesh library -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <!-- Camera utils -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="scripts.js"></script>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const resultDiv = document.getElementById('result');
    const heightInput = document.getElementById('heightInput');
    const unitSelect = document.getElementById('unitSelect');
    const videoContainer = document.getElementById('videoContainer');

    let camera;

    function startCamera() {
      if (!heightInput.value) {
        alert("Please enter your height.");
        return;
      }

      videoContainer.style.display = 'block';

      const heightRaw = parseFloat(heightInput.value);
      const unit = unitSelect.value;
      const heightCm = unit === "feet" ? heightRaw * 30.48 : heightRaw;

      const faceMesh = new FaceMesh({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`,
      });

      faceMesh.setOptions({
        maxNumFaces: 1,
        refineLandmarks: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      faceMesh.onResults((results) => onResults(results, heightCm));

      camera = new Camera(video, {
        onFrame: async () => {
          await faceMesh.send({ image: video });
        },
        width: 300,
        height: 300,
      });

      camera.start();
    }

    function distance(a, b) {
      return Math.hypot(a.x - b.x, a.y - b.y);
    }
    function onResults(results, heightCm) {
      if (!results.multiFaceLandmarks.length) return;

      const landmarks = results.multiFaceLandmarks[0];
      const leftJaw = landmarks[234];
      const rightJaw = landmarks[454];
      const chin = landmarks[152];
      const forehead = landmarks[10];

      const faceWidth = distance(leftJaw, rightJaw);
      const faceHeight = distance(forehead, chin);
      const ratio = faceWidth / faceHeight;

      let fatLevel = "Unknown";
      let advice = "";

      if (ratio > 0.85) {
        fatLevel = "High Fat";
        advice = "Consider adjusting your diet and doing regular cardio. Track visible facial bloating.";
      } else if (ratio > 0.75) {
        fatLevel = "Medium Fat";
        advice = "You're in a moderate range. Focus on hydration and balanced eating to refine your look.";
      } else {
        fatLevel = "Low Fat";
        advice = "Great! Your facial structure shows low fat levels. Maintain your current habits.";
      }

      resultDiv.style.display = 'block';
      resultDiv.innerHTML = `<h3 style="margin-top:0;">Estimated Fat Level: <span style="color: var(--accent-color);">${fatLevel}</span></h3>
        <p>Face Ratio: ${ratio.toFixed(2)}, Height: ${heightCm.toFixed(1)} cm</p>
        <p style="margin-top: 10px;"><i>Advice:</i> ${advice}</p>`;

      camera.stop();
    }
  </script>
</body>

</html>